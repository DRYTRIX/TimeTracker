{% extends "base.html" %}
{% from "components/cards.html" import info_card, stat_card %}
{% from "components/ui.html" import confirm_dialog %}

{% block extra_css %}
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/theme/toastui-editor-dark.css">
{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
    <div>
        <h1 class="text-3xl font-bold text-text-light dark:text-text-dark mb-2">{{ _('Dashboard') }}</h1>
        <p class="text-text-muted-light dark:text-text-muted-dark">{{ _("Here's a quick overview of your work.") }}</p>
    </div>
    <div class="text-sm text-text-muted-light dark:text-text-muted-dark mt-2 md:mt-0 flex items-center gap-2">
        <i class="fas fa-tachometer-alt text-primary"></i>
        <span>/ {{ _('Dashboard') }}</span>
    </div>
</div>

<!-- Key Stats with Sparklines -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
    <!-- Today's Hours Card -->
    <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 border border-blue-200 dark:border-blue-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 dashboard-widget" id="todayHours">
        <div class="flex items-center justify-between mb-4">
            <div>
                <p class="text-sm font-medium text-blue-600 dark:text-blue-400 mb-1">{{ _('Today\'s Hours') }}</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold text-blue-900 dark:text-blue-100 stat-value" id="todayHoursValue">{{ "%.2f"|format(today_hours) }}</span>
                    <span class="text-sm text-blue-600/70 dark:text-blue-400/70">hours</span>
                </div>
            </div>
            <div class="bg-blue-500/10 dark:bg-blue-400/10 p-4 rounded-full">
                <i class="fas fa-clock text-blue-600 dark:text-blue-400 text-2xl"></i>
            </div>
        </div>
        <div class="sparkline-container" data-sparkline='[2.5, 3.2, 2.8, 3.5, 4.1, 3.9, 4.2]' data-color="#3b82f6" id="sparkline-today"></div>
    </div>
    <!-- Week's Hours Card -->
    <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 border border-green-200 dark:border-green-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 dashboard-widget" id="weekHours">
        <div class="flex items-center justify-between mb-4">
            <div>
                <p class="text-sm font-medium text-green-600 dark:text-green-400 mb-1">{{ _('Week\'s Hours') }}</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold text-green-900 dark:text-green-100 stat-value" id="weekHoursValue">{{ "%.2f"|format(week_hours) }}</span>
                    <span class="text-sm text-green-600/70 dark:text-green-400/70">hours</span>
                </div>
            </div>
            <div class="bg-green-500/10 dark:bg-green-400/10 p-4 rounded-full">
                <i class="fas fa-calendar-week text-green-600 dark:text-green-400 text-2xl"></i>
            </div>
        </div>
        <div class="sparkline-container" data-sparkline='[18.5, 20.2, 22.8, 24.5, 26.1, 28.9, 30.2]' data-color="#10b981" id="sparkline-week"></div>
    </div>
    <!-- Month's Hours Card -->
    <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 border border-purple-200 dark:border-purple-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 dashboard-widget" id="monthHours">
        <div class="flex items-center justify-between mb-4">
            <div>
                <p class="text-sm font-medium text-purple-600 dark:text-purple-400 mb-1">{{ _('Month\'s Hours') }}</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold text-purple-900 dark:text-purple-100 stat-value" id="monthHoursValue">{{ "%.2f"|format(month_hours) }}</span>
                    <span class="text-sm text-purple-600/70 dark:text-purple-400/70">hours</span>
                </div>
            </div>
            <div class="bg-purple-500/10 dark:bg-purple-400/10 p-4 rounded-full">
                <i class="fas fa-calendar-alt text-purple-600 dark:text-purple-400 text-2xl"></i>
            </div>
        </div>
        <div class="sparkline-container" data-sparkline='[120.5, 135.2, 148.8, 162.5, 176.1, 188.9, 202.2]' data-color="#8b5cf6" id="sparkline-month"></div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Left Column: Active Timer & Recent Entries -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Active Timer -->
        <div class="{% if active_timer %}bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800{% else %}bg-card-light dark:bg-card-dark{% endif %} p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 dashboard-widget animated-card">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="{% if active_timer %}bg-blue-500/10 dark:bg-blue-400/10{% else %}bg-gray-100 dark:bg-gray-800{% endif %} p-3 rounded-lg">
                        <i class="fas fa-stopwatch {% if active_timer %}text-blue-600 dark:text-blue-400 animate-pulse{% else %}text-gray-600 dark:text-gray-400{% endif %} text-xl"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-text-light dark:text-text-dark">{{ _('Timer') }}</h2>
                </div>
                {% if not active_timer %}
                <button type="button" id="openStartTimer" class="bg-primary hover:bg-primary-dark text-white px-5 py-2.5 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">
                    <i class="fas fa-play mr-2"></i>{{ _('Start Timer') }}
                </button>
                {% endif %}
            </div>
            {% if active_timer %}
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">
                                <span class="w-2 h-2 bg-blue-600 dark:bg-blue-400 rounded-full mr-2 animate-pulse"></span>
                                {{ _('Running') }}
                            </span>
                        </div>
                        <p class="font-semibold text-lg text-text-light dark:text-text-dark mb-1">
                            {% if active_timer.project %}
                                <i class="fas fa-folder text-blue-600 dark:text-blue-400 mr-2"></i>{{ active_timer.project.name }}
                            {% elif active_timer.client %}
                                <i class="fas fa-building text-blue-600 dark:text-blue-400 mr-2"></i>{{ active_timer.client.name }} <span class="text-xs text-gray-500">({{ _('Direct') }})</span>
                            {% else %}
                                {{ _('No project') }}
                            {% endif %}
                        </p>
                        <p class="text-sm text-text-muted-light dark:text-text-muted-dark">
                            <i class="fas fa-clock mr-1"></i>{{ _('Started at') }} {{ active_timer.start_time|user_time('%I:%M %p') }}
                        </p>
                    </div>
                    <form action="{{ url_for('timer.stop_timer') }}" method="POST" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-5 py-2.5 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5">
                            <i class="fas fa-stop mr-2"></i>{{ _('Stop Timer') }}
                        </button>
                    </form>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <p class="text-text-muted-light dark:text-text-muted-dark mb-3">{{ _('No active timer.') }}</p>
                    <p class="text-sm text-text-muted-light dark:text-text-muted-dark">{{ _('Click "Start Timer" to begin tracking your time.') }}</p>
                </div>
            {% endif %}
        </div>

        <!-- Recent Entries -->
        <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 dashboard-widget animated-card">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="bg-primary/10 dark:bg-primary/20 p-3 rounded-lg">
                        <i class="fas fa-history text-primary text-xl"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-text-light dark:text-text-dark">{{ _('Recent Entries') }}</h2>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="border-b-2 border-border-light dark:border-border-dark">
                        <tr>
                            <th class="p-4 text-sm font-semibold text-text-muted-light dark:text-text-muted-dark">{{ _('Source') }}</th>
                            <th class="p-4 text-sm font-semibold text-text-muted-light dark:text-text-muted-dark">{{ _('Task') }}</th>
                            <th class="p-4 text-sm font-semibold text-text-muted-light dark:text-text-muted-dark">{{ _('Notes') }}</th>
                            <th class="p-4 text-sm font-semibold text-text-muted-light dark:text-text-muted-dark">{{ _('Tags') }}</th>
                            <th class="p-4 text-sm font-semibold text-text-muted-light dark:text-text-muted-dark">{{ _('Duration') }}</th>
                            <th class="p-4 text-sm font-semibold text-text-muted-light dark:text-text-muted-dark">{{ _('Date') }}</th>
                            <th class="p-4 text-sm font-semibold text-text-muted-light dark:text-text-muted-dark">{{ _('Actions') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in recent_entries %}
                        <tr class="border-b border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-background-dark transition-colors duration-150">
                            <td class="p-4">
                                {% if entry.project %}
                                    <a href="{{ url_for('projects.view_project', project_id=entry.project.id) }}" class="inline-flex items-center gap-2 text-primary hover:text-primary-dark hover:underline font-medium">
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">
                                            <i class="fas fa-folder mr-1"></i>{{ entry.project.name }}
                                        </span>
                                    </a>
                                {% elif entry.client %}
                                    <a href="{{ url_for('clients.view_client', client_id=entry.client.id) }}" class="inline-flex items-center gap-2 text-primary hover:text-primary-dark hover:underline font-medium">
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400">
                                            <i class="fas fa-building mr-1"></i>{{ entry.client.name }} <span class="ml-1 text-xs opacity-75">({{ _('Direct') }})</span>
                                        </span>
                                    </a>
                                {% else %}
                                    <span class="text-text-muted-light dark:text-text-muted-dark">{{ _('N/A') }}</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                {% if entry.task %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300">
                                        {{ entry.task.name }}
                                    </span>
                                {% else %}
                                    <span class="text-text-muted-light dark:text-text-muted-dark">-</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                {% if entry.notes %}
                                    <span class="text-sm text-text-light dark:text-text-dark" title="{{ entry.notes|striptags }}">{{ entry.notes|striptags|truncate(60) }}</span>
                                {% else %}
                                    <span class="text-text-muted-light dark:text-text-muted-dark">-</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                {% if entry.tags %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">
                                        {{ entry.tags }}
                                    </span>
                                {% else %}
                                    <span class="text-text-muted-light dark:text-text-muted-dark">-</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                                    <i class="fas fa-clock mr-1"></i>{{ entry.duration_formatted }}
                                </span>
                            </td>
                            <td class="p-4 text-sm text-text-light dark:text-text-dark">{{ entry.start_time|user_datetime('%Y-%m-%d %H:%M') }}</td>
                            <td class="p-4">
                                <div class="flex gap-2">
                                    <a href="{{ url_for('timer.resume_timer', timer_id=entry.id) }}" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-green-100 hover:bg-green-200 dark:bg-green-900/30 dark:hover:bg-green-900/50 text-green-600 dark:text-green-400 transition-colors" title="{{ _('Resume - Start a new timer with same properties') }}">
                                        <i class="fas fa-play text-xs"></i>
                                    </a>
                                    <a href="{{ url_for('timer.edit_timer', timer_id=entry.id) }}" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-primary/10 hover:bg-primary/20 dark:bg-primary/20 dark:hover:bg-primary/30 text-primary dark:text-primary transition-colors" title="{{ _('Edit entry') }}">
                                        <i class="fas fa-edit text-xs"></i>
                                    </a>
                                    <a href="{{ url_for('timer.duplicate_timer', timer_id=entry.id) }}" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-blue-100 hover:bg-blue-200 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400 transition-colors" title="{{ _('Duplicate entry') }}">
                                        <i class="fas fa-copy text-xs"></i>
                                    </a>
                                    {% if current_user.is_admin or entry.user_id == current_user.id %}
                                    <form id="confirmDeleteEntry-{{ entry.id }}-form" method="POST" action="{{ url_for('timer.delete_timer', timer_id=entry.id) }}" class="hidden">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    </form>
                                    <button type="button" class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-red-100 hover:bg-red-200 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 transition-colors" title="{{ _('Delete entry') }}" onclick="document.getElementById('confirmDeleteEntry-{{ entry.id }}').classList.remove('hidden')">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="p-12 text-center">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="bg-gray-100 dark:bg-gray-800 rounded-full p-6 w-20 h-20 mx-auto mb-4 flex items-center justify-center">
                                        <i class="fas fa-inbox text-3xl text-gray-400"></i>
                                    </div>
                                    <p class="text-text-muted-light dark:text-text-muted-dark font-medium mb-1">{{ _('No recent entries found.') }}</p>
                                    <p class="text-sm text-text-muted-light dark:text-text-muted-dark">{{ _('Start tracking time to see entries here.') }}</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Right Column: Real Insights -->
    <div class="space-y-6">
        <!-- Weekly Goal Widget -->
        {% if is_module_enabled('weekly_goals') %}
            {% if current_week_goal %}
            <div class="bg-gradient-to-br from-blue-500 to-purple-600 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 dashboard-widget animated-card text-white">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                            <i class="fas fa-bullseye text-xl"></i>
                        </div>
                        <h2 class="text-lg font-semibold">{{ _('Weekly Goal') }}</h2>
                    </div>
                    <a href="{{ url_for('weekly_goals.index') }}" class="text-white/80 hover:text-white transition-colors">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-3 opacity-90">
                        <span class="font-medium">{{ current_week_goal.actual_hours }}h / {{ current_week_goal.target_hours }}h</span>
                        <span class="font-bold">{{ current_week_goal.progress_percentage }}%</span>
                    </div>
                    <div class="w-full bg-white/30 backdrop-blur-sm rounded-full h-3 overflow-hidden shadow-inner">
                        <div class="bg-white rounded-full h-3 transition-all duration-500 shadow-sm" 
                             style="width: {{ current_week_goal.progress_percentage }}%"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm mb-3">
                    <div class="bg-white/20 backdrop-blur-sm rounded-lg p-3 border border-white/10">
                        <div class="opacity-90 text-xs mb-1">{{ _('Remaining') }}</div>
                        <div class="font-bold text-lg">{{ current_week_goal.remaining_hours }}h</div>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm rounded-lg p-3 border border-white/10">
                        <div class="opacity-90 text-xs mb-1">{{ _('Days Left') }}</div>
                        <div class="font-bold text-lg">{{ current_week_goal.days_remaining }}</div>
                    </div>
                </div>
                {% if current_week_goal.days_remaining > 0 and current_week_goal.remaining_hours > 0 %}
                <div class="mt-3 text-sm opacity-90 bg-white/10 backdrop-blur-sm rounded-lg p-2 border border-white/10">
                    <i class="fas fa-info-circle mr-2"></i>
                    {{ _('Need') }} {{ current_week_goal.average_hours_per_day }}h/day {{ _('to reach goal') }}
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 animated-card border-2 border-dashed border-gray-300 dark:border-gray-600">
                <div class="text-center py-2">
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-full p-6 w-20 h-20 mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-bullseye text-3xl text-gray-400"></i>
                    </div>
                    <h3 class="text-base font-semibold text-text-light dark:text-text-dark mb-2">
                        {{ _('No Weekly Goal') }}
                    </h3>
                    <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-4">
                        {{ _('Set a weekly time goal to track your progress') }}
                    </p>
                    <a href="{{ url_for('weekly_goals.create') }}" 
                       class="inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all duration-200 transform hover:-translate-y-0.5">
                        <i class="fas fa-plus mr-2"></i> {{ _('Create Goal') }}
                    </a>
                </div>
            </div>
            {% endif %}
        {% endif %}

        <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 dashboard-widget animated-card">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-500/10 dark:bg-purple-400/10 p-3 rounded-lg">
                        <i class="fas fa-chart-line text-purple-600 dark:text-purple-400 text-xl"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-text-light dark:text-text-dark">{{ _('Top Projects (30 days)') }}</h2>
                </div>
            </div>
            {% if top_projects %}
                {% set max_hours = top_projects[0].hours if top_projects and top_projects[0].hours > 0 else 1 %}
                <ul class="space-y-4">
                    {% for item in top_projects %}
                    <li class="group">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                <div class="flex-shrink-0 w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-500 flex items-center justify-center text-white text-xs font-bold">
                                    {{ loop.index }}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-text-light dark:text-text-dark truncate">{{ item.project.name }}</div>
                                    <div class="text-xs text-text-muted-light dark:text-text-muted-dark flex items-center gap-2 mt-1">
                                        <span class="inline-flex items-center">
                                            <i class="fas fa-dollar-sign text-green-600 dark:text-green-400 mr-1"></i>
                                            {{ _('Billable') }}: {{ '%.1f'|format(item.billable_hours) }}h
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right ml-3">
                                <div class="font-bold text-lg text-text-light dark:text-text-dark">{{ '%.1f'|format(item.hours) }}h</div>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                            <div class="bg-gradient-to-r from-purple-500 to-indigo-500 h-2 rounded-full transition-all duration-500" style="width: {{ (item.hours / max_hours * 100)|round }}%"></div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="text-center py-8">
                    <div class="bg-gray-100 dark:bg-gray-800 rounded-full p-6 w-20 h-20 mx-auto mb-4 flex items-center justify-center">
                        <i class="fas fa-folder-open text-3xl text-gray-400"></i>
                    </div>
                    <p class="text-text-muted-light dark:text-text-muted-dark font-medium mb-1">{{ _('No activity in the last 30 days.') }}</p>
                    <p class="text-sm text-text-muted-light dark:text-text-muted-dark">{{ _('Start tracking time on projects to see them here.') }}</p>
                </div>
            {% endif %}
        </div>

        <!-- Activity Timeline Widget -->
        <div class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 dashboard-widget">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-500/10 dark:bg-indigo-400/10 p-3 rounded-lg">
                        <i class="fas fa-stream text-indigo-600 dark:text-indigo-400 text-xl"></i>
                    </div>
                    <h2 class="text-lg font-semibold text-text-light dark:text-text-dark">{{ _('Recent Activity') }}</h2>
                </div>
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 animate-pulse">
                    <span class="w-2 h-2 bg-green-600 dark:bg-green-400 rounded-full mr-2"></span>
                    {{ _('Live') }}
                </span>
            </div>
            <div id="activityTimeline" class="activity-timeline">
                {% if recent_activities %}
                    {% for activity in recent_activities %}
                        <div class="activity-timeline-item group">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0 relative">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow">
                                        <i class="fas fa-circle text-xs text-white"></i>
                                    </div>
                                    {% if not loop.last %}
                                    <div class="absolute left-1/2 top-10 w-0.5 h-6 bg-gradient-to-b from-indigo-300 to-transparent dark:from-indigo-700 dark:to-transparent transform -translate-x-1/2"></div>
                                    {% endif %}
                                </div>
                                <div class="flex-1 pb-6 group-last:pb-0">
                                    <p class="text-sm font-medium text-text-light dark:text-text-dark mb-1 group-hover:text-primary dark:group-hover:text-primary transition-colors">{{ activity.description or 'Activity' }}</p>
                                    <p class="text-xs text-text-muted-light dark:text-text-muted-dark flex items-center gap-1">
                                        <i class="fas fa-clock"></i>
                                        {{ activity.created_at|local_datetime_short }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-12">
                        <div class="bg-gray-100 dark:bg-gray-800 rounded-full p-6 w-20 h-20 mx-auto mb-4 flex items-center justify-center">
                            <i class="fas fa-inbox text-3xl text-gray-400"></i>
                        </div>
                        <p class="text-text-muted-light dark:text-text-muted-dark font-medium mb-1">{{ _('No recent activity') }}</p>
                        <p class="text-sm text-text-muted-light dark:text-text-muted-dark">{{ _('Activity will appear here as you use the system.') }}</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Support TimeTracker Widget -->
        <div class="bg-gradient-to-br from-amber-500 via-orange-500 to-amber-600 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 dashboard-widget animated-card text-white">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3 mb-3">
                    <div class="bg-white/20 backdrop-blur-sm p-3 rounded-lg">
                        <i class="fas fa-mug-saucer text-xl"></i>
                    </div>
                    <h2 class="text-lg font-semibold">{{ _('Support TimeTracker') }}</h2>
                </div>
            </div>
            <div class="mb-4">
                <p class="text-sm opacity-90 mb-4">
                    {{ _('Your support helps fund server costs, new features, and keeps TimeTracker free for everyone.') }}
                </p>
                {% if time_entries_count > 0 or total_hours > 0 %}
                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-3 border border-white/10 mb-4">
                    <div class="text-xs opacity-90 space-y-2">
                        {% if time_entries_count > 0 %}
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            <span>{{ _('You\'ve tracked %(count)s time entries', count=time_entries_count) }}</span>
                        </div>
                        {% endif %}
                        {% if total_hours > 0 %}
                        <div class="flex items-center gap-2">
                            <i class="fas fa-check-circle"></i>
                            <span>{{ _('You\'ve logged %(hours)s hours', hours="%.1f"|format(total_hours)) }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="flex gap-2">
                <a href="{{ url_for('main.donate') }}" 
                   class="inline-flex items-center justify-center flex-1 bg-white text-amber-600 px-4 py-3 rounded-lg font-semibold hover:bg-amber-50 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-heart mr-2"></i>
                    {{ _('Learn More') }}
                </a>
                <a href="https://buymeacoffee.com/DryTrix?utm_source=timetracker&utm_medium=dashboard&utm_campaign=support" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   onclick="trackDonationClick('dashboard_widget')"
                   class="inline-flex items-center justify-center flex-1 bg-amber-700 hover:bg-amber-800 text-white px-4 py-3 rounded-lg font-semibold transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                    <i class="fas fa-mug-saucer mr-2"></i>
                    {{ _('Donate Now') }}
                    <i class="fas fa-external-link-alt ml-2 text-xs"></i>
                </a>
            </div>
        </div>
    </div>
    <!-- Delete Entry Confirmation Dialogs -->
    {% for entry in recent_entries %}
    {% if current_user.is_admin or entry.user_id == current_user.id %}
    {{ confirm_dialog(
        'confirmDeleteEntry-' ~ entry.id,
        'Delete Time Entry',
        'Are you sure you want to delete this time entry? This action cannot be undone.',
        'Delete',
        'Cancel',
        'danger'
    ) }}
    {% endif %}
    {% endfor %}

    <!-- Start Timer Modal -->
    <div id="startTimerModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50" data-overlay></div>
        <div class="relative max-w-lg mx-auto mt-24 bg-card-light dark:bg-card-dark text-text-light dark:text-text-dark rounded-lg shadow-lg">
            <div class="p-4 border-b border-border-light dark:border-border-dark flex items-center justify-between">
                <div class="text-lg font-semibold">{{ _('Start Timer') }}</div>
                <button type="button" data-close class="px-2 py-1 text-sm hover:bg-background-light dark:hover:bg-background-dark rounded">{{ _('Close') }}</button>
            </div>
            <form method="POST" action="{{ url_for('timer.start_timer') }}" id="startTimerForm" class="p-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="startTimerProject" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ _('Project') }}</label>
                            <select id="startTimerProject" name="project_id" class="form-input">
                                <option value="">{{ _('Select a project (optional)') }}</option>
                                {% for project in active_projects %}
                                <option value="{{ project.id }}">{{ project.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="startTimerClient" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ _('Client') }}</label>
                            <select id="startTimerClient" name="client_id" class="form-input">
                                <option value="">{{ _('Select a client (optional)') }}</option>
                                {% for client in active_clients %}
                                <option value="{{ client.id }}">{{ client.name }}</option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1">
                                {{ _('Select either a project or a client') }}
                            </p>
                        </div>
                    </div>
                    <div>
                        <label for="startTimerTask" class="block text-sm font-medium text-gray-700 dark:text-gray-300">{{ _('Task (optional)') }}</label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="startTimerTask" 
                                name="task_name" 
                                list="startTimerTaskList" 
                                autocomplete="off"
                                class="form-input w-full"
                                placeholder="{{ _('Select existing task or type new task name') }}"
                            />
                            <input type="hidden" id="startTimerTaskId" name="task_id" value="" />
                            <datalist id="startTimerTaskList">
                                <!-- Options will be populated dynamically via JavaScript -->
                            </datalist>
                        </div>
                        <p class="text-xs text-text-muted-light dark:text-text-muted-dark mt-1">
                            {{ _('Select an existing task or type a new task name to create it') }}
                        </p>
                    </div>
                    <div>
                        <label for="startTimerNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ _('Notes (optional)') }}</label>
                        <div class="markdown-editor-wrapper">
                            <textarea id="startTimerNotes" name="notes" class="hidden" placeholder="{{ _('What are you working on?') }}"></textarea>
                            <div id="startTimerNotes_editor"></div>
                        </div>
                    </div>
                    {% if templates %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">{{ _('Or use a template') }}</label>
                        <div class="space-y-2">
                            {% for template in templates %}
                            <button type="button" 
                                    onclick="applyTemplate({{ template.id }})"
                                    class="w-full text-left p-3 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">{{ template.name }}</div>
                                        {% if template.project %}
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                            <i class="fas fa-folder"></i> {{ template.project.name }}
                                            {% if template.task %} → {{ template.task.name }}{% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </button>
                            {% endfor %}
                            <a href="{{ url_for('time_entry_templates.list_templates') }}" 
                               class="block text-center text-sm text-blue-600 dark:text-blue-400 hover:underline pt-2">
                                {{ _('View all templates') }} →
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg">{{ _('Start') }}</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}


{% block scripts_extra %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            if (typeof anime !== 'undefined') {
                anime({
                    targets: '.animated-card',
                    translateY: [20, 0],
                    opacity: [0, 1],
                    delay: (window.anime && anime.stagger) ? anime.stagger(100) : undefined,
                    duration: 500,
                    easing: 'easeOutQuad'
                });
            }
        } catch(e) { /* no-op if animation lib missing */ }

        const modal = document.getElementById('startTimerModal');
        // Open via event delegation to avoid missed binding
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('#openStartTimer');
            if (btn && modal) {
                e.preventDefault();
                modal.classList.remove('hidden');
            }
        });
        if (modal) {
            modal.querySelector('[data-close]')?.addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target === modal || e.target.hasAttribute('data-overlay')) modal.classList.add('hidden'); });

            const projectSelect = document.getElementById('startTimerProject');
            const clientSelect = document.getElementById('startTimerClient');
            const taskInput = document.getElementById('startTimerTask');
            const taskInputId = document.getElementById('startTimerTaskId');
            const taskDatalist = document.getElementById('startTimerTaskList');
            let availableTasks = []; // Store tasks for matching

            async function loadTasksForProject(pid, preserveTaskId = false) {
                if (!taskInput || !taskDatalist) return;
                
                // Preserve current task_id if requested
                const preservedTaskId = preserveTaskId && taskInputId ? taskInputId.value : null;
                const preservedTaskName = preserveTaskId && taskInput ? taskInput.value : null;
                
                // Clear datalist and task input
                taskDatalist.innerHTML = '';
                taskInput.value = '';
                taskInputId.value = '';
                availableTasks = [];
                
                if (!pid) {
                    taskInput.disabled = false;
                    return;
                }
                
                try {
                    const res = await fetch(`/api/projects/${pid}/tasks`, { credentials: 'same-origin' });
                    const data = await res.json();
                    if (data && data.tasks) {
                        availableTasks = data.tasks;
                        data.tasks.forEach(t => {
                            const opt = document.createElement('option');
                            opt.value = t.name;
                            opt.dataset.taskId = t.id;
                            taskDatalist.appendChild(opt);
                        });
                    }
                    
                    // Restore preserved values if requested
                    if (preserveTaskId && preservedTaskId) {
                        taskInputId.value = preservedTaskId;
                        if (preservedTaskName) {
                            taskInput.value = preservedTaskName;
                        }
                    }
                    
                    taskInput.disabled = false;
                } catch (err) {
                    console.error('Failed to load tasks', err);
                    taskInput.disabled = true;
                }
            }

            // Handle task input change to detect selection vs typing
            if (taskInput) {
                taskInput.addEventListener('input', () => {
                    const inputValue = taskInput.value.trim();
                    // Try to find matching task
                    const matchedTask = availableTasks.find(t => t.name === inputValue);
                    if (matchedTask) {
                        taskInputId.value = matchedTask.id;
                    } else {
                        // Clear task_id if no match (new task name)
                        taskInputId.value = '';
                    }
                });
                
                // Also handle selection from datalist
                taskInput.addEventListener('change', () => {
                    const inputValue = taskInput.value.trim();
                    const matchedTask = availableTasks.find(t => t.name === inputValue);
                    if (matchedTask) {
                        taskInputId.value = matchedTask.id;
                    } else {
                        taskInputId.value = '';
                    }
                });
            }

            if (projectSelect && clientSelect && taskInput) {
                projectSelect.addEventListener('change', () => {
                    const pid = projectSelect.value;
                    if (pid) {
                        clientSelect.value = '';
                    }
                    loadTasksForProject(pid);
                });

                clientSelect.addEventListener('change', () => {
                    const cid = clientSelect.value;
                    if (cid) {
                        projectSelect.value = '';
                        taskInput.value = '';
                        taskInputId.value = '';
                        taskDatalist.innerHTML = '';
                        availableTasks = [];
                        taskInput.disabled = true;
                    } else {
                        taskInput.disabled = false;
                    }
                });
            }
            
            // Form validation: ensure either project or client is selected
            const startTimerForm = modal ? modal.querySelector('form') : null;
            if (startTimerForm) {
                // Store original button state to restore if needed
                const submitBtn = startTimerForm.querySelector('button[type="submit"]');
                let originalButtonHTML = submitBtn ? submitBtn.innerHTML : null;
                
                startTimerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Validate project or client selection
                    const projectVal = projectSelect ? projectSelect.value : '';
                    const clientVal = clientSelect ? clientSelect.value : '';
                    if (!projectVal && !clientVal) {
                        const errorMsg = '{{ _("Please select either a project or a client") }}';
                        if (window.toastManager && typeof window.toastManager.error === 'function') {
                            window.toastManager.error(errorMsg, '{{ _("Error") }}', 5000);
                        } else {
                            alert(errorMsg);
                        }
                        return false;
                    }
                    
                    // Handle new task creation if needed
                    const taskName = taskInput ? taskInput.value.trim() : '';
                    const taskId = taskInputId ? taskInputId.value : '';
                    
                    // If task name is provided but no task_id, create the task first
                    if (taskName && !taskId && projectVal) {
                        try {
                            // Disable submit button
                            if (submitBtn) {
                                submitBtn.disabled = true;
                                if (originalButtonHTML) {
                                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>{{ _("Creating task...") }}';
                                }
                            }
                            
                            // Create task via AJAX
                            const csrfToken = startTimerForm.querySelector('input[name="csrf_token"]')?.value;
                            const createTaskRes = await fetch('/api/tasks/create', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRFToken': csrfToken || ''
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({
                                    name: taskName,
                                    project_id: parseInt(projectVal)
                                })
                            });
                            
                            if (!createTaskRes.ok) {
                                const errorData = await createTaskRes.json().catch(() => ({}));
                                throw new Error(errorData.error || 'Failed to create task');
                            }
                            
                            const taskData = await createTaskRes.json();
                            // Set the task_id in the hidden field BEFORE reloading
                            if (taskInputId && taskData.id) {
                                taskInputId.value = taskData.id;
                                // Also update the input to show the created task name
                                if (taskInput) {
                                    taskInput.value = taskData.name;
                                }
                            }
                            
                            // Reload tasks list to include the new task, preserving the task_id
                            await loadTasksForProject(projectVal, preserveTaskId=true);
                            
                        } catch (error) {
                            console.error('Failed to create task:', error);
                            const errorMsg = '{{ _("Failed to create task: ") }}' + (error.message || error);
                            if (window.toastManager && typeof window.toastManager.error === 'function') {
                                window.toastManager.error(errorMsg, '{{ _("Error") }}', 5000);
                            } else {
                                alert(errorMsg);
                            }
                            // Restore button state
                            if (submitBtn && originalButtonHTML) {
                                submitBtn.innerHTML = originalButtonHTML;
                                submitBtn.disabled = false;
                            }
                            return false;
                        }
                    }
                    
                    // Ensure task_id is set if we have a task name that matches an existing task
                    if (taskName && !taskInputId.value) {
                        const matchedTask = availableTasks.find(t => t.name === taskName);
                        if (matchedTask && taskInputId) {
                            taskInputId.value = matchedTask.id;
                        }
                    }
                    
                    // Restore button state
                    if (submitBtn && originalButtonHTML) {
                        submitBtn.innerHTML = originalButtonHTML;
                        submitBtn.disabled = false;
                    }
                    
                    // Debug: Log form data before submission
                    if (taskInputId && taskInputId.value) {
                        console.log('Submitting form with task_id:', taskInputId.value);
                    }
                    
                    // Now submit the form normally
                    startTimerForm.submit();
                }, true); // Use capture phase to run before other handlers
            }
        }
        
        // Template application function
        window.applyTemplate = async function(templateId) {
            try {
                const response = await fetch(`/api/templates/${templateId}`, { credentials: 'same-origin' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const template = await response.json();
                
                // Get form elements (re-select to avoid scope issues)
                const projectSelect = document.getElementById('startTimerProject');
                const taskInput = document.getElementById('startTimerTask');
                const taskInputId = document.getElementById('startTimerTaskId');
                const notesField = document.getElementById('startTimerNotes');
                
                if (!projectSelect || !taskInput || !notesField) {
                    throw new Error('Form elements not found');
                }
                
                // Apply template values to form
                if (template.project_id) {
                    projectSelect.value = template.project_id;
                    // Trigger change event to load tasks
                    projectSelect.dispatchEvent(new Event('change'));
                    
                    // Wait a bit for tasks to load, then select task
                    setTimeout(() => {
                        if (template.task_id && taskInputId) {
                            taskInputId.value = template.task_id;
                            // Find task name from loaded tasks
                            const taskDatalist = document.getElementById('startTimerTaskList');
                            if (taskDatalist) {
                                const matchingOption = Array.from(taskDatalist.options).find(
                                    opt => opt.dataset.taskId === String(template.task_id)
                                );
                                if (matchingOption) {
                                    taskInput.value = matchingOption.value;
                                }
                            }
                        }
                    }, 300);
                }
                if (template.default_notes) {
                    notesField.value = template.default_notes;
                    // Update markdown editor if it exists
                    if (window.dashboardNotesEditor && typeof window.dashboardNotesEditor.setMarkdown === 'function') {
                        try {
                            window.dashboardNotesEditor.setMarkdown(template.default_notes);
                        } catch (e) {}
                    }
                }
                
                // Mark template as used
                fetch(`/api/templates/${templateId}/use`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                }).catch(() => {});  // Silently fail if marking fails
                
            } catch (error) {
                console.error('Error applying template:', error);
                alert('Failed to apply template. Please try again.');
            }
        };
    });

    // Initialize Toast UI Editor for timer notes
    const notesInput = document.getElementById('startTimerNotes');
    if (notesInput && window.toastui && window.toastui.Editor) {
        const theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        window.dashboardNotesEditor = new toastui.Editor({
            el: document.getElementById('startTimerNotes_editor'),
            height: '250px',
            initialEditType: 'wysiwyg',
            previewStyle: 'vertical',
            usageStatistics: false,
            hideModeSwitch: false,
            placeholder: '{{ _("What are you working on?") }}',
            theme: theme,
            toolbarItems: [
                ['heading', 'bold', 'italic', 'strike'],
                ['hr', 'quote'],
                ['ul', 'ol', 'task'],
                ['link', 'code', 'codeblock', 'table'],
                ['image'],
                ['scrollSync']
            ],
            initialValue: notesInput.value || ''
        });

        // Apply theme changes dynamically if supported
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class' && window.dashboardNotesEditor) {
                    const nextTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                    try {
                        if (typeof window.dashboardNotesEditor.setTheme === 'function') {
                            window.dashboardNotesEditor.setTheme(nextTheme);
                        }
                    } catch (e) {}
                }
            });
        });
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });

        // Multiple image upload handler
        window.dashboardNotesEditor.removeHook && window.dashboardNotesEditor.removeHook('addImageBlobHook');
        
        // Create custom multiple file input
        const dashboardFileInput = document.createElement('input');
        dashboardFileInput.type = 'file';
        dashboardFileInput.accept = 'image/*';
        dashboardFileInput.multiple = true;
        dashboardFileInput.style.display = 'none';
        document.body.appendChild(dashboardFileInput);
        
        // Intercept image button click after editor is fully initialized
        setTimeout(() => {
            try {
                const toolbar = window.dashboardNotesEditor.getUI().getToolbar();
                if (toolbar) {
                    // Find image button by tooltip or class
                    const imageButton = toolbar.querySelector('[data-tooltip="Insert image"], .toastui-editor-toolbar-icons.image');
                    if (imageButton) {
                        imageButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            dashboardFileInput.click();
                        });
                    }
                }
            } catch (err) {
                console.warn('Could not intercept image button, falling back to default behavior', err);
                // Fallback to default single image upload
                window.dashboardNotesEditor.addHook && window.dashboardNotesEditor.addHook('addImageBlobHook', async (blob, callback) => {
                    try {
                        const formData = new FormData();
                        formData.append('image', blob, blob.name || 'upload.png');
                        const res = await fetch('{{ url_for('api.upload_editor_image') }}', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await res.json();
                        if (data && data.url) {
                            callback(data.url, blob.name || 'image');
                        } else {
                            console.warn('Upload failed', data);
                        }
                    } catch (e) { console.error('Image upload error', e); }
                });
            }
        }, 500);
        
        // Handle multiple file selection
        dashboardFileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // Show loading indicator (optional - could use toast notification)
            const loadingMsg = files.length > 1 ? `Uploading ${files.length} images...` : 'Uploading image...';
            
            try {
                const formData = new FormData();
                files.forEach(file => {
                    formData.append('images', file);
                });
                
                const res = await fetch('{{ url_for('api.upload_editor_images_bulk') }}', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                if (data && data.urls && data.urls.length > 0) {
                    // Insert all images into editor
                    const currentMarkdown = window.dashboardNotesEditor.getMarkdown();
                    const imagesMarkdown = data.urls.map((url, index) => {
                        const fileName = files[index].name || 'image';
                        return `![${fileName}](${url})`;
                    }).join('\n\n');
                    
                    // Insert images at cursor position or append
                    window.dashboardNotesEditor.insertText(imagesMarkdown);
                    
                    // Show warnings if any
                    if (data.warnings && data.warnings.length > 0) {
                        console.warn('Some images failed to upload:', data.warnings);
                    }
                } else {
                    console.error('Upload failed', data);
                    alert('Failed to upload images. Please try again.');
                }
            } catch (error) {
                console.error('Multiple image upload error', error);
                alert('Failed to upload images. Please try again.');
            }
            
            // Reset file input
            dashboardFileInput.value = '';
        });

        // Sync editor content to hidden textarea on form submit
        const startTimerForm = document.getElementById('startTimerForm');
        if (startTimerForm) {
            startTimerForm.addEventListener('submit', function(e) {
                if (window.dashboardNotesEditor && notesInput) {
                    try {
                        notesInput.value = window.dashboardNotesEditor.getMarkdown();
                    } catch (err) {
                        console.error('Failed to sync markdown editor:', err);
                    }
                }
            });
        }
    }
});
</script>

<!-- Toast UI Editor -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
{% endblock %}
