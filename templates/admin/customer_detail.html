{% extends "base.html" %}

{% block title %}{{ organization.name }} - {{ _('Customer Detail') }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    {% from "_components.html" import page_header %}
    <div class="row">
        <div class="col-12">
            {% set actions %}
            <a href="{{ url_for('admin.customers') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>{{ _('Back to Customers') }}
            </a>
            {% endset %}
            {{ page_header('fas fa-building', organization.name, organization.slug, actions) }}
        </div>
    </div>

    <!-- Organization Info and Actions -->
    <div class="row section-spacing">
        <!-- Organization Status -->
        <div class="col-md-6 mb-4">
            <div class="card hover-lift">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-info-circle me-2 text-primary"></i>{{ _('Organization Status') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6"><strong>{{ _('Status') }}:</strong></div>
                        <div class="col-6">
                            {% if organization.is_active %}
                            <span class="badge bg-success">{{ _('Active') }}</span>
                            {% elif organization.is_suspended %}
                            <span class="badge bg-danger">{{ _('Suspended') }}</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ organization.status|title }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6"><strong>{{ _('Created') }}:</strong></div>
                        <div class="col-6">{{ organization.created_at.strftime('%Y-%m-%d') if organization.created_at else 'N/A' }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6"><strong>{{ _('Active Members') }}:</strong></div>
                        <div class="col-6">
                            <span class="badge bg-info">{{ memberships|selectattr('status', 'equalto', 'active')|list|length }}</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6"><strong>{{ _('Contact Email') }}:</strong></div>
                        <div class="col-6">{{ organization.contact_email or 'N/A' }}</div>
                    </div>

                    <!-- Actions -->
                    <div class="mt-4 border-top pt-3">
                        <h6>{{ _('Actions') }}</h6>
                        <div class="d-grid gap-2">
                            {% if organization.is_active %}
                            <form method="POST" action="{{ url_for('admin.suspend_organization', org_id=organization.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Are you sure you want to suspend this organization?') }}');">
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="fas fa-ban me-2"></i>{{ _('Suspend Organization') }}
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{{ url_for('admin.activate_organization', org_id=organization.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-check me-2"></i>{{ _('Activate Organization') }}
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subscription Info -->
        <div class="col-md-6 mb-4">
            <div class="card hover-lift">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-credit-card me-2 text-primary"></i>{{ _('Subscription') }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if organization.stripe_customer_id %}
                        <div class="row mb-3">
                            <div class="col-6"><strong>{{ _('Plan') }}:</strong></div>
                            <div class="col-6">{{ organization.subscription_plan_display }}</div>
                        </div>
                        
                        {% if organization.stripe_subscription_id %}
                        <div class="row mb-3">
                            <div class="col-6"><strong>{{ _('Status') }}:</strong></div>
                            <div class="col-6">
                                <span class="badge bg-{% if organization.has_active_subscription %}success{% elif organization.has_billing_issue %}danger{% else %}warning{% endif %}">
                                    {{ organization.stripe_subscription_status|title if organization.stripe_subscription_status else 'Unknown' }}
                                </span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6"><strong>{{ _('Seats') }}:</strong></div>
                            <div class="col-6">{{ organization.subscription_quantity }}</div>
                        </div>
                        {% if organization.next_billing_date %}
                        <div class="row mb-3">
                            <div class="col-6"><strong>{{ _('Next Billing') }}:</strong></div>
                            <div class="col-6">{{ organization.next_billing_date.strftime('%Y-%m-%d') }}</div>
                        </div>
                        {% endif %}
                        
                        <!-- Subscription Management Actions -->
                        <div class="mt-4 border-top pt-3">
                            <h6>{{ _('Subscription Management') }}</h6>
                            
                            <!-- Update Quantity -->
                            <form method="POST" action="{{ url_for('admin.update_subscription_quantity', org_id=organization.id) }}" class="mb-2">
                                <div class="input-group input-group-sm mb-2">
                                    <span class="input-group-text">{{ _('Seats') }}</span>
                                    <input type="number" name="quantity" class="form-control" value="{{ organization.subscription_quantity }}" min="1" required>
                                    <button type="submit" class="btn btn-primary">{{ _('Update') }}</button>
                                </div>
                            </form>

                            <!-- Cancel/Reactivate -->
                            {% if organization.subscription_ends_at %}
                            <form method="POST" action="{{ url_for('admin.reactivate_subscription', org_id=organization.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success w-100 mb-2">
                                    <i class="fas fa-redo me-2"></i>{{ _('Reactivate Subscription') }}
                                </button>
                            </form>
                            {% else %}
                            <form method="POST" action="{{ url_for('admin.cancel_subscription', org_id=organization.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Cancel at period end?') }}');">
                                <input type="hidden" name="at_period_end" value="true">
                                <button type="submit" class="btn btn-sm btn-warning w-100 mb-2">
                                    <i class="fas fa-times me-2"></i>{{ _('Cancel at Period End') }}
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('admin.cancel_subscription', org_id=organization.id) }}" class="d-inline" onsubmit="return confirm('{{ _('Cancel immediately? This cannot be undone.') }}');">
                                <input type="hidden" name="at_period_end" value="false">
                                <button type="submit" class="btn btn-sm btn-danger w-100">
                                    <i class="fas fa-ban me-2"></i>{{ _('Cancel Immediately') }}
                                </button>
                            </form>
                            {% endif %}
                        </div>
                        {% else %}
                        <p class="text-muted">{{ _('No active subscription') }}</p>
                        {% endif %}
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                {{ _('Stripe Customer ID') }}: <code>{{ organization.stripe_customer_id }}</code>
                            </small>
                        </div>
                    {% else %}
                        <p class="text-muted">{{ _('No Stripe customer account') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Members -->
    <div class="row section-spacing">
        <div class="col-12 mb-4">
            <div class="card hover-lift">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-users me-2 text-primary"></i>{{ _('Members') }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>{{ _('User') }}</th>
                                    <th>{{ _('Email') }}</th>
                                    <th>{{ _('Role') }}</th>
                                    <th>{{ _('Status') }}</th>
                                    <th>{{ _('Last Activity') }}</th>
                                    <th>{{ _('Joined') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for membership in memberships %}
                                <tr>
                                    <td>{{ membership.user.display_name }}</td>
                                    <td>{{ membership.user.email or 'N/A' }}</td>
                                    <td>
                                        <span class="badge bg-{% if membership.is_admin %}primary{% else %}secondary{% endif %}">
                                            {{ membership.role|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if membership.is_active %}success{% elif membership.is_pending %}warning{% else %}secondary{% endif %}">
                                            {{ membership.status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if membership.last_activity_at %}
                                            {{ membership.last_activity_at.strftime('%Y-%m-%d %H:%M') }}
                                        {% elif membership.user.last_login %}
                                            {{ membership.user.last_login.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                            <span class="text-muted">{{ _('Never') }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ membership.created_at.strftime('%Y-%m-%d') if membership.created_at else 'N/A' }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-3">
                                        <span class="text-muted">{{ _('No members') }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoices & Billing -->
    {% if stripe_data %}
    <div class="row section-spacing">
        <div class="col-md-6 mb-4">
            <div class="card hover-lift">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-file-invoice me-2 text-primary"></i>{{ _('Recent Invoices') }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if stripe_data.invoices %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>{{ _('Number') }}</th>
                                    <th>{{ _('Date') }}</th>
                                    <th>{{ _('Amount') }}</th>
                                    <th>{{ _('Status') }}</th>
                                    <th>{{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in stripe_data.invoices %}
                                <tr>
                                    <td><small>{{ invoice.number or invoice.id[:8] }}</small></td>
                                    <td>{{ invoice.created.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ "%.2f"|format(invoice.amount_paid) }} {{ invoice.currency }}</td>
                                    <td>
                                        <span class="badge bg-{% if invoice.paid %}success{% elif invoice.status == 'open' %}warning{% else %}secondary{% endif %}">
                                            {{ invoice.status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            {% if invoice.hosted_invoice_url %}
                                            <a href="{{ invoice.hosted_invoice_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                            {% endif %}
                                            {% if invoice.paid and invoice.amount_paid > 0 %}
                                            <button type="button" class="btn btn-outline-warning btn-sm" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#refundModal" 
                                                    data-invoice-id="{{ invoice.id }}"
                                                    data-amount="{{ invoice.amount_paid }}"
                                                    data-currency="{{ invoice.currency }}">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <span class="text-muted">{{ _('No invoices') }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Payment Methods & Refunds -->
        <div class="col-md-6 mb-4">
            <div class="card hover-lift mb-3">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-credit-card me-2 text-primary"></i>{{ _('Payment Methods') }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if stripe_data.payment_methods %}
                    <ul class="list-unstyled mb-0">
                        {% for pm in stripe_data.payment_methods %}
                        <li class="mb-2">
                            <i class="fab fa-cc-{{ pm.card.brand }}"></i>
                            {{ pm.card.brand|title }} •••• {{ pm.card.last4 }}
                            <span class="text-muted">({{ pm.card.exp_month }}/{{ pm.card.exp_year }})</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mb-0">{{ _('No payment methods') }}</p>
                    {% endif %}
                </div>
            </div>

            {% if stripe_data.refunds %}
            <div class="card hover-lift">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-undo me-2 text-primary"></i>{{ _('Recent Refunds') }}
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        {% for refund in stripe_data.refunds %}
                        <li class="mb-2">
                            {{ "%.2f"|format(refund.amount) }} {{ refund.currency|upper }}
                            <span class="badge bg-{{ 'success' if refund.status == 'succeeded' else 'warning' }}">{{ refund.status }}</span>
                            <br><small class="text-muted">{{ refund.created.strftime('%Y-%m-%d') }} - {{ refund.reason or 'No reason' }}</small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Events -->
    <div class="row">
        <div class="col-12">
            <div class="card hover-lift">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-history me-2 text-primary"></i>{{ _('Recent Events') }}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_events %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>{{ _('Date') }}</th>
                                    <th>{{ _('Event Type') }}</th>
                                    <th>{{ _('Status') }}</th>
                                    <th>{{ _('Notes') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in recent_events %}
                                <tr>
                                    <td>{{ event.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td><code>{{ event.event_type }}</code></td>
                                    <td>
                                        <span class="badge bg-{% if event.processed %}success{% else %}warning{% endif %}">
                                            {{ _('Processed') if event.processed else _('Pending') }}
                                        </span>
                                    </td>
                                    <td>{{ event.notes or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <span class="text-muted">{{ _('No recent events') }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refund Modal -->
<div class="modal fade" id="refundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="refundForm">
                <div class="modal-header">
                    <h5 class="modal-title">{{ _('Create Refund') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{{ _('Amount') }}</label>
                        <input type="number" name="amount" class="form-control" step="0.01" placeholder="{{ _('Leave empty for full refund') }}">
                        <small class="text-muted">{{ _('Original amount') }}: <span id="originalAmount"></span></small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">{{ _('Reason') }}</label>
                        <select name="reason" class="form-select">
                            <option value="requested_by_customer">{{ _('Requested by customer') }}</option>
                            <option value="duplicate">{{ _('Duplicate') }}</option>
                            <option value="fraudulent">{{ _('Fraudulent') }}</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-warning">{{ _('Create Refund') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Handle refund modal data
const refundModal = document.getElementById('refundModal');
if (refundModal) {
    refundModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const invoiceId = button.getAttribute('data-invoice-id');
        const amount = button.getAttribute('data-amount');
        const currency = button.getAttribute('data-currency');
        
        const form = document.getElementById('refundForm');
        form.action = '{{ url_for('admin.create_refund', org_id=organization.id, invoice_id='INVOICE_ID') }}'.replace('INVOICE_ID', invoiceId);
        
        document.getElementById('originalAmount').textContent = amount + ' ' + currency.toUpperCase();
    });
}
</script>
{% endblock %}

