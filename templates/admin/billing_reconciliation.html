{% extends "base.html" %}

{% block title %}{{ _('Billing Reconciliation') }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    {% from "_components.html" import page_header %}
    <div class="row">
        <div class="col-12">
            {% set actions %}
            <a href="{{ url_for('admin.customers') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>{{ _('Back to Customers') }}
            </a>
            {% endset %}
            {{ page_header('fas fa-sync', _('Billing Reconciliation'), _('Monitor sync status between Stripe and local database'), actions) }}
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row section-spacing">
        <div class="col-md-3 col-sm-6 mb-3">
            {% from "_components.html" import summary_card %}
            {{ summary_card('fas fa-building', 'primary', 'Total Organizations', sync_results.total) }}
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            {{ summary_card('fas fa-check-circle', 'success', 'Synced', sync_results.synced) }}
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            {{ summary_card('fas fa-exclamation-triangle', 'warning', 'With Discrepancies', sync_results.with_discrepancies) }}
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            {{ summary_card('fas fa-times-circle', 'danger', 'Errors', sync_results.errors) }}
        </div>
    </div>

    <!-- Sync Results -->
    <div class="row">
        <div class="col-12">
            <div class="card hover-lift">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="fas fa-list me-2 text-primary"></i>{{ _('Organization Sync Status') }}
                    </h5>
                    <form method="GET" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="fas fa-sync me-2"></i>{{ _('Refresh') }}
                        </button>
                    </form>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>{{ _('Organization') }}</th>
                                    <th>{{ _('Sync Status') }}</th>
                                    <th>{{ _('Discrepancies') }}</th>
                                    <th>{{ _('Details') }}</th>
                                    <th>{{ _('Actions') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for org_result in sync_results.organizations %}
                                <tr class="{% if not org_result.synced %}table-danger{% elif org_result.discrepancy_count > 0 %}table-warning{% endif %}">
                                    <td>
                                        <strong>{{ org_result.name }}</strong><br>
                                        <small class="text-muted">{{ org_result.slug }}</small>
                                    </td>
                                    <td>
                                        {% if org_result.synced %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>{{ _('Synced') }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times me-1"></i>{{ _('Error') }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if org_result.discrepancy_count > 0 %}
                                        <span class="badge bg-warning">{{ org_result.discrepancy_count }}</span>
                                        {% else %}
                                        <span class="text-muted">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if org_result.error %}
                                        <span class="text-danger"><small>{{ org_result.error }}</small></span>
                                        {% elif org_result.discrepancies %}
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#discrepancies-{{ org_result.id }}">
                                            <i class="fas fa-eye me-1"></i>{{ _('View Details') }}
                                        </button>
                                        <div id="discrepancies-{{ org_result.id }}" class="collapse mt-2">
                                            <div class="alert alert-warning mb-0">
                                                <ul class="mb-0">
                                                    {% for disc in org_result.discrepancies %}
                                                    <li>
                                                        <strong>{{ disc.field }}</strong>: 
                                                        {% if disc.error %}
                                                            {{ disc.error }}
                                                        {% else %}
                                                            Local: <code>{{ disc.local }}</code> â†’ Stripe: <code>{{ disc.stripe }}</code>
                                                        {% endif %}
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                        {% else %}
                                        <span class="text-success">
                                            <i class="fas fa-check-circle"></i> {{ _('No issues') }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="POST" action="{{ url_for('admin.sync_organization', org_id=org_result.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-sync me-1"></i>{{ _('Re-sync') }}
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Info -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>{{ _('About Billing Reconciliation') }}</h5>
                <p class="mb-2">{{ _('This tool checks for discrepancies between your local database and Stripe. Common issues include:') }}</p>
                <ul class="mb-0">
                    <li>{{ _('Subscription status mismatches (e.g., cancelled in Stripe but active locally)') }}</li>
                    <li>{{ _('Quantity differences (number of seats)') }}</li>
                    <li>{{ _('Missing subscriptions in Stripe') }}</li>
                    <li>{{ _('Billing cycle date inconsistencies') }}</li>
                </ul>
                <p class="mt-2 mb-0"><strong>{{ _('Note') }}:</strong> {{ _('Discrepancies are automatically corrected when detected. Use re-sync to check for new issues.') }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

